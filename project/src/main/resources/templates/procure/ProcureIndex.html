<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/basic :: setContent(~{this::content})}">
    <th:block th:fragment="content">
        <style>
            table {
                text-align: center;
            }

            .scrollable-tbody {
                max-height: 755px; /* 스크롤 가능 영역 높이 */
                overflow-y: auto; /* 세로 스크롤 활성화 */
            }

            .scrollable-tbody table {
                width: 100%; /* 테이블 크기 맞춤 */
                border-collapse: collapse; /* 테두리 병합 */
            }



        </style>
        <div class="container-fluid">
            <!-- ========== title-wrapper start ========== -->
            <div class="title-wrapper pt-30">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="title">
                            <h2>조달 계획 등록 및 조회</h2>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="breadcrumb-wrapper">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item">
                                        <a href="#0">조달 관리</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="#0">조달 계획 등록 및 조회</a>
                                    </li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ========== title-wrapper end ========== -->



            <!-- ========== 생산 계획 조회 ========== -->


            <div class="row">
                <div class="col-lg-6">
                    <div class="card-style mb-30">
                        <h3 class="mb-10">생산 계획 조회</h3>
                        <div class="search_tab">
                            <form method="get" th:action="@{/plan/procureRegister}">
                                <div class="select-style-1">

                                    <input style="text-align:right"
                                           class="select-style-1 search"
                                           name="keyword"
                                           placeholder=" 제품명 및 생산 계획 코드를 입력하세요."
                                           th:value="${keyword}"
                                           type="text"
                                    />
                                    <button class="main-btn active-btn btn-hover blue_botton" type="submit">
                                        검색
                                    </button>
                                </div>
                            </form>
                        </div>


                        <div class="table-wrapper table-responsive">
                            <table class="table striped-table">
                                <thead>
                                <tr>
                                    <th><h5>생산 시작일</h5></th>
                                    <th><h5>생산 종료일</h5></th>
                                    <th><h5>생산계획코드</h5></th>
                                    <th><h5>생산제품코드</h5></th>
                                    <th><h5>생산제품명</h5></th>
                                    <th><h5>생산수량</h5></th>
                                    <th><h5>선택목록</h5></th>
                                </tr>
                                </thead>
                                <tbody>

                                <tr th:each="plan : ${plans}">
                                    <td><p th:text="${plan.productionStartDate}"></p></td>
                                    <td><p th:text="${plan.productionEndDate}"></p></td>
                                    <td><p th:text="${plan.productionPlanCode}"></p></td>
                                    <td><p th:text="${plan.productCode}"></p></td>
                                    <td><p th:text="${plan.productName}"></p></td>
                                    <td><p th:text="${plan.productionQuantity}"></p></td>
                                    <td>
                                        <a class="main-btn active-btn btn-hover" style="padding: 6px"
                                           th:href="@{/plan/procureRegister(
                                           id=${plan.planId},
                                           page=${currentPage},
                                           size=${pageSize},
                                           keyword=${keyword},
                                           productCode=${plan.productCode})}">
                                            선택
                                        </a>

                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            </form>
                            <div class="pagination-wrapper">
                                <ul class="pagination" th:if="${totalPages > 0}">
                                    <li th:if="${currentPage > 1}">
                                        <a aria-label="Previous"
                                           th:href="@{/plan/procureRegister(page=${currentPage - 1}, size=${pageSize}, keyword=${keyword})}">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li th:each="i : ${#numbers.sequence(1, totalPages)}">
                                        <a th:classappend="${i == currentPage ? 'active' : ''}"
                                           th:href="@{/plan/procureRegister(page=${i}, size=${pageSize}, keyword=${keyword})}"
                                           th:text="${i}"></a>
                                    </li>
                                    <li th:if="${currentPage < totalPages}">
                                        <a aria-label="Next"
                                           th:href="@{/plan/procureRegister(page=${currentPage + 1}, size=${pageSize}, keyword=${keyword})}">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <!-- ========== 조달 계획 조회 ========== -->


                    <div class="card-style mb-30">
                        <h3 class="mb-10">조달 계획 조회</h3>
                        <div class="search_tab">
                            <form method="get" th:action="@{/plan/procureRegister}">
                                <div class="select-style-1">

                                    <input style="text-align:right"
                                           class="select-style-1 search"
                                           name="keyword"
                                           placeholder=" 제품명 및 생산 계획 코드를 입력하세요."
                                           th:value="${keyword}"
                                           type="text"
                                    />
                                    <button class="main-btn active-btn btn-hover blue_botton" type="submit">
                                        검색
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="table-wrapper table-responsive">
                            <table class="table striped-table" id="checkProcurementPlan">
                                <thead>
                                <tr>
                                    <th><h5>생산계획코드</h5></th>
                                    <th style="width: 95px"><h5>생산제품명</h5></th>
                                    <th style="width: 100px"><h5>공급업체</h5></th>
                                    <th><h5>부품명</h5></th>
                                    <th style="width: 80px"><h5>조달수량</h5></th>
                                    <th style="width: 95px"><h5>조달납기일</h5></th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                            <ul id="pagination">
                                <!-- 동적으로 페이지 버튼이 생성됩니다 -->
                            </ul>

                        </div>
                    </div>
                </div>


                <!-- ========== 조달 계획 등록 ========== -->


                <div class="col-lg-6">
                    <div class="card-style mb-30 right-div">
                        <h3 class="mb-10">조달 계획 등록</h3>
                        <div class="table-wrapper table-responsive">
                            <table class="table striped-table" id="procurement-table">
                                <thead>
                                <tr>
                                    <th>생산 시작일</th>
                                    <th>생산 종료일</th>
                                    <th>생산계획 코드</th>
                                    <th>생산제품코드</th>
                                    <th>생산제품명</th>
                                    <th>생산수량</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:if="${selectedPlan != null}">
                                    <td th:text="${selectedPlan.productionStartDate}"></td>
                                    <td th:text="${selectedPlan.productionEndDate}"></td>
                                    <td th:text="${selectedPlan.productionPlanCode}"></td>
                                    <td th:text="${selectedPlan.productCode}"></td>
                                    <td th:text="${selectedPlan.productName}"></td>
                                    <td th:text="${selectedPlan.productionQuantity}"></td>
                                </tr>
                                </tbody>
                            </table>


                            <div class="table-wrapper">
                                <table class="table striped-table">
                                    <thead>
                                    <tr>
                                        <th style="width: 130px"><h5>공급업체</h5></th>
                                        <th style="width: 180px"><h5>자재명</h5></th>
                                        <th style="width: 70px"><h5>필요수량</h5></th>
                                        <th style="width: 70px"><h5>가용재고</h5></th>
                                        <th style="width: 70px"><h5>조달수량</h5></th>
                                        <th style="width: 105px"><h5>조달납기일</h5></th>
                                        <th><h5>등록</h5></th>
                                    </tr>
                                    </thead>
                                </table>

                                <div class="scrollable-tbody">
                                    <table class="table striped-table">
                                        <tbody>
                                        <tr th:each="bom : ${selectedBom}"
                                            >
                                            <!-- 생산계획이 많다보니 미래에 필요한 양도 계산할 수 있어야할 것으로 보임.... 일단은 전부 출력하게 바꿔둠-->
                                            <!-- 출력할 가용재고의 양을 계산하는 수식을 바꿔야할지도....        -->
<!--                                            th:if="${(bom.requireQuantity * selectedPlan.productionQuantity - bom.availableStock) > 0}">-->
                                            <td style="width: 130px" >
                                                <div class="select-style-1" style="width: 120px; height: 10px">
                                                    <div class="select-position">
                                                        <select style="font-size: 13px; height: 55px"
                                                                name="componentType"
                                                                required>
                                                            <option value="공급업체 목록" disabled selected>공급업체 목록</option>
                                                            <option th:each="supplier : ${bom.suppliers}"
                                                                    th:value="${supplier.supplierId}"
                                                                    th:text="${supplier.supplierName}"
                                                                    th:selected="${#lists.size(bom.suppliers) > 0}">
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="width: 180px" th:text="${bom.materialName}" ></td>
                                            <td style="width: 70px" th:text="${bom.requireQuantity * selectedPlan.productionQuantity}"></td>
                                            <td style="width: 70px" th:text="${bom.availableStock}"></td>
                                            <td style="width: 70px" th:text="${
                                            (bom.requireQuantity * selectedPlan.productionQuantity - bom.availableStock) > 0 ?
                                            bom.requireQuantity * selectedPlan.productionQuantity - bom.availableStock
                                            : 0
                                            }">
                                            </td>
                                            <td style="width: 70px">
                                                <input style="width: 110px" id="startDate" required type="date" th:value="${bom.dayAfterLeadTime}">
                                            </td>
                                            <td>
                                                <div class="action">
                                                    <a
                                                            class="main-btn active-btn btn-hover register"
                                                            type="button"
                                                            style="padding: 6px"
                                                            th:attr="
                                            data-bom-id=${bom.bomId},
                                            data-procurement-quantity=${(bom.requireQuantity * selectedPlan.productionQuantity - bom.availableStock) > 0 ? bom.requireQuantity * selectedPlan.productionQuantity - bom.availableStock : 0},
                                            data-material-name=${bom.materialName},
                                            data-required-quantity=${bom.requireQuantity * selectedPlan.productionQuantity},
                                            data-product-code=${bom.productCode},
                                            data-available-stock=${bom.availableStock},
                                            data-product-name=${selectedPlan.productName},
                                            data-production-plan-code=${selectedPlan.productionPlanCode},
                                            data-material-code=${bom.materialCode}"
                                                            onclick="registerProcurement(this)">
                                                        등록
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>


    </th:block>
</th:block>

<script>
    let currentPage = 1;
    let totalPages = 1;
    let allPlans = [];     // 전체 데이터를 담을 배열

    function registerProcurement(button) {
        const bomId = button.getAttribute('data-bom-id');  // BOM ID 가져오기
        console.log("BOM ID:", bomId);


        // 해당 셀렉트에서 공급업체 값 추출
        const row = button.closest('tr'); // 버튼이 속한 tr 요소 찾기
        const supplierSelect = row.querySelector('select[name="componentType"]');  // 해당 행의 select 요소 찾기
        const supplierId = supplierSelect ? supplierSelect.value : null;  // 선택된 공급업체 ID 가져오기
        const supplierName = supplierSelect ? supplierSelect.options[supplierSelect.selectedIndex].text : null;  // 선택된 공급업체 이름 가져오기

        // 조달수량 추출 (해당 row에서 계산된 수량 값 가져오기)
        const procurementQuantity = button.getAttribute('data-procurement-quantity');  // 5번째 td가 '조달수량'이므로, 해당 값을 가져옵니다.
        const procurementDueDate = row.querySelector('input[type="date"]').value;  // 해당 row에서 날짜 입력값 가져오기

        const materialCode = button.getAttribute('data-material-code');
        const materialName = button.getAttribute('data-material-name');
        const requiredQuantity = parseFloat(button.getAttribute('data-required-quantity'));
        const availableStock = parseFloat(button.getAttribute('data-available-stock'));


        const productCode = button.getAttribute('data-product-code');
        const productName = button.getAttribute('data-product-name');
        const productionPlanCode = button.getAttribute('data-production-plan-code');

        if (!procurementDueDate) {
            alert("조달납기일을 입력해 주세요.");
            return;
        }

        const procurementData = {
            productionPlanCode: productionPlanCode,
            productCode: productCode,
            productName: productName,
            supplierName: supplierName,
            materialName: materialName,
            materialCode: materialCode,
            procurementQuantity: parseInt(procurementQuantity),
            procurementDueDate: procurementDueDate,
            createDate: new Date().toISOString()  // 현재 시간을 createDate로 추가
        };

        fetch('/procure/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(procurementData)
        })
            .then(response => response.json())
            .then(data => {

                loadProcurementPlans(1);

            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function loadProcurementPlans(page = 1) {
        fetch(`/procure/list?page=1&size=1000`) // 모든 데이터를 가져옴 (최대값으로 설정)
            .then(response => response.json())
            .then(data => {
                // 전체 데이터를 역순으로 정렬
                const allPlans = data.plans.reverse();

                // 페이지에 맞는 데이터 추출
                const startIndex = (page - 1) * 5;
                const endIndex = page * 5;
                const currentPagePlans = allPlans.slice(startIndex, endIndex);

                // 테이블 업데이트
                updateTable(currentPagePlans);

                // 전체 페이지 수 계산
                totalPages = Math.ceil(allPlans.length / 5);
                currentPage = page;

                // 페이징 정보 업데이트
                updatePagination();
            })
            .catch(error => {
                console.error('Error loading procurement plans:', error);
            });
    }

    function updateTable(plans) {
        const tableBody = document.querySelector('#checkProcurementPlan tbody');
        tableBody.innerHTML = ''; // 기존 테이블 내용 초기화

        // 테이블에 데이터 추가
        plans.forEach(plan => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${plan.productionPlanCode}</td>
            <td>${plan.productName}</td>
            <td>${plan.supplierName}</td>
            <td>${plan.materialName}</td>
            <td>${plan.procurementQuantity}</td>
            <td>${plan.procurementDueDate}</td>
        `;
            tableBody.appendChild(row);
        });
    }

    function updatePagination() {
        const paginationContainer = document.querySelector('#pagination');
        paginationContainer.innerHTML = '';  // 기존 페이지 버튼 초기화

        // 이전 버튼
        if (currentPage > 1) {
            const prevButton = document.createElement('a');
            prevButton.textContent = '«';
            prevButton.onclick = () => loadProcurementPlans(currentPage - 1);
            paginationContainer.appendChild(prevButton);
        }

        // 페이지 번호 버튼
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('a');
            pageButton.textContent = i;

            pageButton.onclick = () => loadProcurementPlans(i);
            if (i === currentPage) {
                pageButton.classList.add('active');
                pageButton.disabled = true; // 현재 페이지는 비활성화
            }
            paginationContainer.appendChild(pageButton);
        }

        // 다음 버튼
        if (currentPage < totalPages) {
            const nextButton = document.createElement('a');
            nextButton.textContent = '»';
            nextButton.onclick = () => loadProcurementPlans(currentPage + 1);
            paginationContainer.appendChild(nextButton);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadProcurementPlans(1);  // 페이지 로딩 시 첫 번째 페이지 로드
    });


</script>
